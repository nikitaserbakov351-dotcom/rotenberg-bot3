import random
import re
from datetime import datetime
from typing import Dict, List


class RotenbergBrain:
    """Мозг бота в стиле Романа Ротенберга с 300+ фразами"""

    def __init__(self):
        self.conversation_history = []
        self._init_phrases()

    def _init_phrases(self):
        """База из 300+ фраз в стиле Ротенберга"""

        # РЕАЛЬНЫЕ ЦИТАТЫ И СТИЛИЗОВАННЫЕ ФРАЗЫ
        self.real_quotes = [
            # Про команду и игроков
            "У меня солдаты на льду, а не просто игроки",
            "Каждый должен быть готов отдать все за команду",
            "Мы воюем каждую смену, каждую секунду",
            "Это не индивидуальный спорт, здесь важна командная работа",
            "У нас свой стиль, своя философия игры",

            # Про судейство
            "Давайте чтобы все было у нас правильно и честно",
            "Когда арбитр не видит очевидного — это проблема",
            "Мы за честную борьбу, без посторонней помощи",
            "Судьи должны быть профессионалами, а не зрителями",
            "Нельзя прощать такие ошибки на профессиональном уровне",

            # Про критиков
            "Могу поспорить с вами на миллион долларов",
            "Критики сидят в теплых офисах, а мы на льду",
            "Легко говорить, когда сам ничего не делаешь",
            "У каждого свое мнение, но факты — вещь упрямая",
            "Некоторые пишут из-за бугра, им не понять",

            # Про победы и поражения
            "Мы обязаны Кубок привезем в город",
            "Победа — это не случайность, а закономерность",
            "Поражения закаляют характер",
            "Каждая игра — это урок, даже проигранная",
            "Мы учимся на своих ошибках",

            # Философские
            "Хоккей — это война на льду",
            "Я солдат, который выполняет приказ",
            "Давление — это часть нашей работы",
            "Без жертв нет побед",
            "Иногда нужно быть жестким",

            # Футбольные аналогии
            "Это как у Месси в лучшие годы",
            "Смотрите как в топ-клубах Европы делают",
            "Помните такого игрока — Шулшер?",
            "Принципы как в футболе, только на коньках",
            "Хоккейный Месси — это про наших ребят"
        ]

        # КАТЕГОРИЗИРОВАННЫЕ ФРАЗЫ
        self.phrases = {
            # КРИТИКА (40 вариантов)
            'критика': [
                "Вы знаете, мне вообще-то некогда это обсуждать. У меня команда готовится.",
                "Могу поспорить с вами на миллион долларов, что вы не разбираетесь в хоккее.",
                "Некоторые говорят из-за бугра, им не понять нашей ментальности.",
                "Это легко критиковать, сидя в теплой студии. Попробуйте сами выйти на лёд.",
                "Вы хоть один матч отыграли на профессиональном уровне? Нет? Тогда и не говорите.",
                "Я слышу вашу критику, но факты говорят об обратном.",
                "Когда ты ничего не делаешь, проще всего критиковать других.",
                "У нас своя правда, своя история. И мы её пишем на льду.",
                "Критиковать можно бесконечно, а работать надо здесь и сейчас.",
                "Вы думаете, я не знаю проблем? Я их вижу лучше всех.",
                "Говорите что хотите, но результаты будут говорить сами за себя.",
                "Каждый эксперт, но когда дело доходит до практики — все молчат.",
                "Слова — это одно, дела — совершенно другое.",
                "Вы можете не соглашаться, но это не изменит фактов.",
                "Мне интересно, а что бы вы сделали на моем месте?",
                "Критика должна быть конструктивной, а не разрушительной.",
                "Я готов выслушать, если есть конкретные предложения.",
                "Но ведь вы же понимаете, что не всё так просто?",
                "Давайте по фактам, а не по эмоциям.",
                "Это ваше мнение, я его услышал. Но у меня свое.",
                "Когда тебя бьют — надо не ныть, а давать сдачи.",
                "Всегда найдутся те, кому не нравится, как мы играем.",
                "Спорт — это не про то, чтобы нравиться всем.",
                "Можно тысячу раз говорить, но один раз сделать — важнее.",
                "Я не люблю оправдываться. Есть результат или его нет.",
                "Вы смотрите со стороны, а я изнутри вижу процесс.",
                "Легко быть умным после матча.",
                "Каждый думает, что знает, как надо тренировать.",
                "Если бы всё было так просто, все бы уже чемпионами были.",
                "Я принимаю ответственность, но и требую уважения.",
                "Не надо делать из мухи слона.",
                "Мы работаем, а не разговариваем.",
                "Слова ничего не стоят, если за ними нет дела.",
                "Вы бы попробовали в нашей шкуре побыть.",
                "Всегда проще советовать, чем делать.",
                "Я не прошу снисхождения, я прошу объективности.",
                "Критика — это хорошо, если она по делу.",
                "Давайте без этих ярлыков и штампов.",
                "Я знаю свою работу лучше, чем кто-либо.",
                "Спокойно, всё под контролем."
            ],

            # КОМАНДА (35 вариантов)
            'команда': [
                "У меня не просто игроки, у меня солдаты на льду. Каждый готов бороться до конца.",
                "Смотрите на наших парней — они воюют каждую смену. Это как у Месси, только на коньках.",
                "Мы создаём здесь не просто коллектив, а семью. Где один за всех, и все за одного.",
                "Каждый игрок в этом составе — как винтик в швейцарских часах. Должна быть идеальная слаженность.",
                "Помните такого игрока — Шулшер? Вот чтобы так же работать — от и до.",
                "Наша команда — это единый механизм. Если одна шестерёнка встанет, весь механизм остановится.",
                "Я горжусь каждым своим игроком. Они проходят через адские нагрузки.",
                "Команда — это не 20 отдельных людей, это один организм.",
                "У нас свой кодекс, свои правила. Здесь все равны.",
                "Каждый знает свою роль и выполняет её на 100%.",
                "Мы воспитываем не просто хоккеистов, а личностей.",
                "Дисциплина — это основа. Без неё нет команды.",
                "Они молодцы, работают не покладая рук.",
                "Вижу, как растут эти ребята. И не только как игроки.",
                "У нас свой микроклимат в раздевалке. Это важно.",
                "Командный дух — это когда готов за товарища жизнь отдать.",
                "Мы все в одной лодке. Или плывём вместе, или тонем вместе.",
                "Никаких звёзд. Все работают на общий результат.",
                "Вижу глаза этих парней после тяжёлой тренировки — они горят.",
                "Они не сдаются, даже когда всё против.",
                "Это поколение, которое изменит хоккей в стране.",
                "У нас свой путь, и мы по нему идём.",
                "Каждый день вижу прогресс. Это вдохновляет.",
                "Они понимают, за что борются.",
                "Не просто выполняют указания, а думают на льду.",
                "Умная команда — это сильная команда.",
                "Физика важна, но голова важнее.",
                "Они учатся на своих ошибках, и это главное.",
                "Вижу характер каждого. У всех разный, но все бойцы.",
                "Не просто отыгрывают смену, а вкладывают душу.",
                "Это мои парни. За них я горой.",
                "Работаем над деталями. В них вся победа.",
                "Понимают, что такое командная ответственность.",
                "Не ищут виноватых, а ищут решения.",
                "Горжусь этой командой, несмотря ни на что."
            ],

            # СУДЬИ (30 вариантов)
            'судьи': [
                "Давайте чтобы всё было у нас правильно и честно. Без этих... сомнительных моментов.",
                "Когда арбитр не видит очевидного — это не ошибка, это вопрос к его компетенции.",
                "Мы за честную борьбу. Чтобы победа была заслуженной, а не подаренной.",
                "Иногда смотришь и думаешь: они что, с другой игры пришли?",
                "Честность на льду — это основа. Без неё хоккей превращается в фарс.",
                "Нельзя так работать. Это же профессиональный спорт.",
                "Видел этот момент? Как это можно не заметить?",
                "Они тоже люди, могут ошибаться. Но есть пределы.",
                "Когда одни и те же ошибки повторяются — это система.",
                "Не хочу говорить про судей, но... сами видели.",
                "Надо уважать труд игроков, а не перечёркивать его свистком.",
                "Есть правила, и их надо соблюдать. Всеми.",
                "Не понимаю таких решений. Объясните мне.",
                "Мы не просим подарков, мы просим справедливости.",
                "Хоккей должен быть чистым. Во всех смыслах.",
                "Когда нарушают правила — должны быть санкции. Всегда.",
                "Нельзя закрывать глаза на очевидное.",
                "Это дискредитация спорта.",
                "Игроки выкладываются, а тут такое...",
                "Надо работать профессионально. И точка.",
                "Вижу, что происходит. И не только я.",
                "Не первый раз, и не последний, к сожалению.",
                "Надо менять подход. Это уже не смешно.",
                "Обидно за ребят. Они заслужили большего.",
                "Не хочу комментировать, чтобы не получить штраф.",
                "Всё видно, всё понятно. Делайте выводы.",
                "Это не уровень. Совсем не уровень.",
                "Ждём от судейства такой же профессионализации, как от игроков.",
                "Нельзя так. Просто нельзя.",
                "Хватит уже. Пора что-то менять."
            ],

            # ПЛАНЫ И ПОБЕДЫ (30 вариантов)
            'планы': [
                "Мы обязаны Кубок привезем в город. Другого варианта я даже не рассматриваю.",
                "План простой — выигрывать каждую игру. По-другому в нашем деле нельзя.",
                "Строим игру от обороны. Надёжный тыл — это половина успеха.",
                "У нас есть чёткая схема, и мы будем её придерживаться. Все решения просчитаны.",
                "Цель одна — золотые медали. Всё остальное — промежуточные этапы.",
                "Работаем поэтапно. Сначала выход из группы, потом плей-офф.",
                "Каждая игра — шаг к цели. Никаких провалов.",
                "Планируем на сезон вперёд, но живём сегодняшним днём.",
                "Тактика зависит от соперника. Готовимся к каждому индивидуально.",
                "Хотим играть в атакующий хоккей. Зрителям должно нравиться.",
                "Работаем над ошибками. Каждый день.",
                "План есть, и мы ему следуем. Не всегда гладко, но идём.",
                "Цели амбициозные, но достижимые.",
                "Никакой самодеятельности. Всё по плану.",
                "Анализируем каждого соперника до мелочей.",
                "Готовим сюрпризы. Не все карты раскрываем.",
                "Система игры отработана до автоматизма.",
                "Учимся на своих и чужих ошибках.",
                "Никакой спешки. Всё в своё время.",
                "Видим слабые места и работаем над ними.",
                "План Б всегда есть. И план В тоже.",
                "Готовы к любым сценариям.",
                "Не загадываем далеко, но мечтаем о многом.",
                "Каждый игрок знает свою задачу.",
                "Работаем на перспективу, но и про сегодня не забываем.",
                "Хотим оставить след в истории клуба.",
                "Планы большие, работа кипит.",
                "Не обещаем, а делаем.",
                "Верим в себя и в свою работу.",
                "Цель вижу, к ней иду."
            ],

            # ВОПРОСЫ (25 вариантов)
            'вопрос': [
                "Вот смотри... Я вам так скажу: вопрос правильный, но ответ не так прост.",
                "Вы хотите простой ответ? Его нет. В хоккее всё сложно.",
                "Хороший вопрос. Давайте я объясню на примере...",
                "Я не буду раскрывать все карты, но направление мысли верное.",
                "Это как в футболе: можно иметь 70% владения мячом, но проиграть 0:1. Суть не в статистике, а в результате.",
                "Сложно ответить однозначно. Зависит от многих факторов.",
                "Интересный вопрос. Над ним стоит подумать.",
                "Если бы я знал ответ на все вопросы...",
                "Каждый случай индивидуален.",
                "Не всё так однозначно, как кажется.",
                "Нужно анализировать, а не делать скоропалительных выводов.",
                "Вопрос в том, а что вы сами думаете?",
                "Давайте разбираться вместе.",
                "Можно с разных сторон посмотреть.",
                "Интересно, а почему вы об этом спрашиваете?",
                "Хм, надо подумать...",
                "Не торопитесь с выводами.",
                "Всё имеет свои причины.",
                "Спросите у меня через полгода.",
                "Сложный вопрос для простого ответа.",
                "Задавайте конкретнее.",
                "Не совсем понимаю, что вы имеете в виду.",
                "Уточните, пожалуйста.",
                "Это тема для отдельного разговора.",
                "Лучше спросите о чём-то другом."
            ],

            # ФИЛОСОФИЯ (30 вариантов)
            'философия': [
                "Хоккей — это война на льду. И на войне все средства хороши.",
                "Главное не то, как ты упал, а то, как ты поднялся. Это про характер.",
                "Давление? Это когда весь город ждёт от тебя победы. Без давления нет и большого спорта.",
                "Иногда нужно быть жёстким. Это не личное, это профессионально.",
                "Успех — это 10% таланта и 90% труда. У нас трудятся все, от игроков до обслуживающего персонала.",
                "Спорт — это жизнь в миниатюре. Со всеми взлётами и падениями.",
                "Важно не то, что говорят, а то, что делают.",
                "Характер воспитывается в трудные моменты.",
                "Без веры в себя ничего не получится.",
                "Работа — это всё. Без работы талант ничего не стоит.",
                "Уважение нужно заслужить, а не требовать.",
                "Скромность в жизни, наглость на льду.",
                "Не ошибается тот, кто ничего не делает.",
                "Важен не старт, а финиш.",
                "Каждая неудача — шаг к успеху.",
                "Терпение и труд всё перетрут.",
                "Главное — не сдаваться никогда.",
                "Цель оправдывает средства, если средства честные.",
                "Честность перед собой — самое важное.",
                "Работай молча, пусть результат кричит.",
                "Сложности закаляют.",
                "Без жертв нет побед.",
                "Вера в команду — половина успеха.",
                "Самодисциплина — основа всего.",
                "Мысли материальны, особенно в спорте.",
                "Надо мечтать о большем, чем можешь.",
                "Страх — это нормально. Главное — его преодолеть.",
                "У каждого свой путь к успеху.",
                "Важно не только выиграть, но и достойно проиграть.",
                "Спорт учит жизни лучше любой школы."
            ],

            # ЭМОЦИИ (25 вариантов)
            'эмоции': [
                "Ну это вообще ни в какие ворота!",
                "Вы серьёзно? Я даже комментировать не буду.",
                "Отлично! Именно так и нужно работать!",
                "Бывает... Главное — выводы сделать.",
                "Вот это по-нашему! Вот это я понимаю!",
                "Не могу поверить!",
                "Как же это обидно!",
                "Да что ж такое-то...",
                "Ух ты! Вот это да!",
                "Невероятно! Просто невероятно!",
                "Я в шоке, честно говоря.",
                "Наконец-то! Ждал этого!",
                "Да ладно! Не может быть!",
                "Вот это поворот!",
                "Не ожидал, честно.",
                "Очень жаль, очень.",
                "Прекрасно! Просто прекрасно!",
                "Ничего себе!",
                "Да как же так?!",
                "Вот это характер!",
                "Молодцы! Словами не передать!",
                "До слёз обидно.",
                "С ума сойти!",
                "Вот это да, вот это да...",
                "Эмоции зашкаливают!"
            ],

            # ЛИЧНОЕ (20 вариантов)
            'личное': [
                "Я солдат, и я выполняю приказ.",
                "Моя работа — это моя жизнь.",
                "Не люблю говорить о личном. Есть дело.",
                "Всё, что я делаю — для команды.",
                "У меня нет личной жизни, есть работа.",
                "Жертвую многим, но это мой выбор.",
                "Не жалуюсь. Сам выбрал эту дорогу.",
                "Семья понимает. Без этого нельзя.",
                "Отдыхаю, когда есть время. А его нет.",
                "Люблю свою работу, несмотря ни на что.",
                "Это не профессия, это призвание.",
                "Отдаю всего себя. По-другому не умею.",
                "Не представляю себя в другом месте.",
                "Это моё, и я этим живу.",
                "Устаю, как все. Но это приятная усталость.",
                "Вижу смысл в том, что делаю.",
                "Не ищу лёгких путей.",
                "Принимаю все вызовы.",
                "Иду до конца, что бы ни было.",
                "Верю в то, что делаю."
            ]
        }

        # ФРАЗЫ-СВЯЗКИ
        self.transitions = [
            "Кстати...",
            "Вот ещё что...",
            "Так вот...",
            "Знаешь...",
            "Слушай...",
            "К слову...",
            "Между прочим...",
            "А вообще...",
            "Если честно...",
            "По правде говоря..."
        ]

    def _analyze_message(self, text: str) -> Dict:
        """Анализирует сообщение и определяет категорию"""
        text_lower = text.lower()

        # Словарь ключевых слов для каждой категории
        keywords = {
            'критика': ['плох', 'ужас', 'проигр', 'слабо', 'критик', 'неудач', 'промах'],
            'команда': ['игрок', 'команд', 'состав', 'трениров', 'парень', 'хоккеис'],
            'судьи': ['суд', 'арбитр', 'несправед', 'ошибк', 'штраф', 'удален'],
            'планы': ['план', 'будущ', 'следующ', 'побед', 'кубок', 'чемпион'],
            'вопрос': ['почему', 'как', 'что', 'зачем', 'когда', 'сколько'],
            'философия': ['жизнь', 'философ', 'принцип', 'смысл', 'вера', 'цель'],
            'эмоции': ['ого', 'ух', 'здорово', 'кошмар', 'ура', 'вау'],
            'личное': ['ты', 'вас', 'тебе', 'вам', 'семья', 'личн']
        }

        # Подсчёт совпадений для каждой категории
        scores = {category: 0 for category in keywords}

        for category, words in keywords.items():
            for word in words:
                if word in text_lower:
                    scores[category] += 1

        # Выбор категории с максимальным количеством совпадений
        if any(score > 0 for score in scores.values()):
            best_category = max(scores, key=scores.get)
            if scores[best_category] > 0:
                return {'category': best_category, 'score': scores[best_category]}

        # Если ничего не найдено, выбираем случайную категорию
        return {'category': random.choice(list(self.phrases.keys())), 'score': 0}

    def get_response(self, user_message: str, user_name: str = "Друг") -> str:
        """Генерирует ответ на сообщение"""

        # 1. Анализируем сообщение
        analysis = self._analyze_message(user_message)
        category = analysis['category']

        # 2. Выбираем базовую фразу из категории
        base_response = random.choice(self.phrases[category])

        # 3. 30% шанс добавить реальную цитату Ротенберга
        if random.random() < 0.3:
            quote = random.choice(self.real_quotes)
            if random.random() < 0.5:
                base_response = f"{base_response} {quote}"
            else:
                base_response = f"{quote} {base_response}"

        # 4. 40% шанс добавить переходную фразу
        if random.random() < 0.4 and len(user_message.split()) > 3:
            transition = random.choice(self.transitions)
            base_response = f"{transition} {base_response}"

        # 5. 25% шанс персонализировать ответ
        if random.random() < 0.25 and user_name:
            if random.random() < 0.5:
                base_response = f"{base_response}, {user_name}"
            else:
                base_response = f"{user_name}, {base_response}"

        # 6. 35% шанс добавить вопрос в конце
        if random.random() < 0.35 and category not in ['вопрос', 'эмоции']:
            questions = [
                " Ты как думаешь?",
                " Согласен?",
                " Что скажешь?",
                " Есть мнение?",
                " Как твоё видение?"
            ]
            base_response += random.choice(questions)

        # 7. Ограничиваем длину
        if len(base_response) > 400:
            sentences = base_response.split('. ')
            if len(sentences) > 2:
                base_response = '. '.join(sentences[:2]) + '.'
            else:
                base_response = base_response[:397] + '...'

        return base_response

    def add_conversation(self, user_msg: str, bot_msg: str):
        """Добавляет разговор в историю"""
        if len(self.conversation_history) > 10:
            self.conversation_history = self.conversation_history[-10:]
        self.conversation_history.append((user_msg, bot_msg))